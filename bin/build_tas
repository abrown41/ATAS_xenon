#!/usr/bin/python
import numpy as np

def read_limits():
    from sys import argv
    return(float(argv[-2]),float(argv[-1]))

def get_limits(lim,freqs):
    index=-1
    for freq in freqs:
        index=index+1
        if freq>lim:
            return(index)



def get_filelist():
    from sys import argv
    return([str(fname) for fname in argv[1:-2] ])

def strip_num(filename):
    import re
    pat=re.compile("[0-9]{2}.[0-9]{2}")
    m=pat.search(filename)
    pat=re.compile("[+,-]")
    n=pat.search(filename)
    return(float(n.group(0)+m.group(0)))


def order_files(filelist):
    from operator import itemgetter
    td_list=[]
    for fname in filelist:
        td_list.append((fname,strip_num(fname))) 

    times=zip(*sorted(td_list,key=itemgetter(1), reverse=True))[1]
    td_list=zip(*sorted(td_list,key=itemgetter(1), reverse=True))[0]

    return(td_list,times)

def get_column(fname,colnum):
    ipf=open(fname,'r')
    lines=ipf.readlines()

    column=[]
    for line in lines:
        column.append(float(line.rsplit()[colnum]))

    return(column)


def get_data(filelist):
    fdata=[]
    for fname in filelist:
        fdata.append(get_column(fname,1))

    return(fdata)

def chop_data(inpdata,dind,uind):

    import numpy as np
    newdat=[]
    for item in inpdata:
        newdat.append(item[dind:uind])

    return(np.asarray(newdat))


def append_filenames(filelist):
    oplist=[]
    for fname in filelist:
        oplist.append(fname+'/TA_spect_len_0001_z')
    return(oplist)


def plot_spect(freqs,times,wdata):
    import matplotlib.pyplot as plt
    lo_lim=1

#    wdata[:lo_lim,:]= 0

    ext=[freqs[0],freqs[-1],times[-1],times[0]]
#    plt.hist(wdata.ravel(), bins=256, range=(0.0, 1.0), fc='k', ec='k')
    plt.imshow(np.abs(wdata[-1:0:-1,:]),interpolation='none', aspect='auto',extent=ext,origin='lower',cmap='jet')
    plt.colorbar()
    plt.show()

filelist=get_filelist()
filelist,times= order_files(filelist)
dt=abs(times[1]-times[0])

filelist=append_filenames(filelist)
energies=get_column(filelist[0],0)


dlim,ulim=read_limits()
dind=get_limits(dlim,energies)
uind=get_limits(ulim,energies)

data_list=get_data(filelist)

cdata=chop_data(data_list,dind,uind)

for ii in range(54):
    cdata[ii,:] = cdata[ii,:] - cdata[0,:]

plot_spect([dlim,ulim],times,cdata)
